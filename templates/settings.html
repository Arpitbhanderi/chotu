{% extends 'base.html' %}
{% block title %}Settings{% endblock %}

{% block content %}
<div class="page-header py-3 px-4">
  <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
    <div>
      <h1 class="page-title mb-0">Settings</h1>
      <small class="text-muted">Admin controls for credentials, preferences, data, and backups</small>
    </div>
    {% if mode == 'settings' %}
    <form action="{{ url_for('settings_logout') }}" method="post" class="m-0">
      <button class="btn btn-sm btn-outline-secondary"><i class="fas fa-sign-out-alt me-1"></i> Logout</button>
    </form>
    {% endif %}
  </div>
</div>

{% if mode == 'login' %}
  <div class="card shadow-sm">
    <div class="card-body p-3">
      <h6 class="card-title mb-3"><i class="fas fa-lock me-1"></i> Admin Login</h6>
      <form action="{{ url_for('settings_login') }}" method="post" class="row g-2 align-items-end">
        <div class="col-sm-5">
          <label class="form-label small mb-1">Username</label>
          <input type="text" name="username" class="form-control form-control-sm" placeholder="admin" required>
        </div>
        <div class="col-sm-5">
          <label class="form-label small mb-1">Password</label>
          <input type="password" name="password" class="form-control form-control-sm" placeholder="admin" required>
        </div>
        <div class="col-sm-2 d-grid">
          <button class="btn btn-sm btn-primary"><i class="fas fa-sign-in me-1"></i> Login</button>
        </div>
      </form>
    </div>
  </div>

{% else %}
  <div class="card shadow-sm">
    <div class="card-body p-3">
      <ul class="nav nav-tabs" id="settingsTabs" role="tablist">
        <li class="nav-item" role="presentation">
          <button class="nav-link active" id="account-tab" data-bs-toggle="tab" data-bs-target="#account" type="button" role="tab">Account</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="preferences-tab" data-bs-toggle="tab" data-bs-target="#preferences" type="button" role="tab">Preferences</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="data-tab" data-bs-toggle="tab" data-bs-target="#data" type="button" role="tab">Data</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="backups-tab" data-bs-toggle="tab" data-bs-target="#backups" type="button" role="tab">Backups</button>
        </li>
      </ul>
      <div class="tab-content pt-3" id="settingsTabsContent">
        <div class="tab-pane fade show active" id="account" role="tabpanel">
          <form action="{{ url_for('change_credentials') }}" method="post" class="row g-2">
            <div class="col-12">
              <label class="form-label small mb-1">Current Password</label>
              <input type="password" name="current_password" class="form-control form-control-sm" required>
            </div>
            <div class="col-md-6">
              <label class="form-label small mb-1">New Username</label>
              <input type="text" name="new_username" class="form-control form-control-sm" placeholder="Leave blank to keep same">
            </div>
            <div class="col-md-6">
              <label class="form-label small mb-1">New Password</label>
              <input type="password" name="new_password" class="form-control form-control-sm" placeholder="Leave blank to keep same">
            </div>
            <div class="col-md-6">
              <label class="form-label small mb-1">Confirm New Password</label>
              <input type="password" name="confirm_password" class="form-control form-control-sm" placeholder="Leave blank to keep same">
            </div>
            <div class="col-12 d-flex gap-2">
              <button class="btn btn-sm btn-success"><i class="fas fa-save me-1"></i> Save Changes</button>
            </div>
          </form>
        </div>
        <div class="tab-pane fade" id="preferences" role="tabpanel">
          <form action="{{ url_for('update_preferences') }}" method="post" class="row g-2">
            <div class="col-md-6">
              <label class="form-label small mb-1">Company Name</label>
              <input type="text" name="company_name" class="form-control form-control-sm" value="{{ prefs.COMPANY_NAME }}">
            </div>
            <div class="col-md-6">
              <label class="form-label small mb-1">Phone</label>
              <input type="text" name="company_phone" class="form-control form-control-sm" value="{{ prefs.COMPANY_PHONE }}">
            </div>
            <div class="col-12">
              <label class="form-label small mb-1">Address</label>
              <input type="text" name="company_address" class="form-control form-control-sm" value="{{ prefs.COMPANY_ADDRESS }}">
            </div>
            <div class="col-md-6">
              <label class="form-label small mb-1">GSTIN</label>
              <input type="text" name="company_gstin" class="form-control form-control-sm" value="{{ prefs.COMPANY_GSTIN }}">
            </div>
            <div class="col-md-6">
              <label class="form-label small mb-1">Default Printer</label>
              <input type="text" name="default_printer" class="form-control form-control-sm" value="{{ prefs.DEFAULT_PRINTER }}" placeholder="Exact printer name">
              <small class="text-muted">Use the exact name; see available printers below.</small>
            </div>
            <div class="col-12 form-check ms-1">
              <input class="form-check-input" type="checkbox" id="auto_print" name="auto_print" {% if prefs.AUTO_PRINT_AFTER_SAVE %}checked{% endif %}>
              <label class="form-check-label" for="auto_print">Auto-print after saving invoice</label>
            </div>
            <div class="col-12 d-flex gap-2">
              <button class="btn btn-sm btn-success"><i class="fas fa-save me-1"></i> Save Preferences</button>
              <button class="btn btn-sm btn-outline-primary" id="refreshPrinters"><i class="fas fa-sync-alt me-1"></i> Refresh Printers</button>
            </div>
            <div class="col-12 mt-2">
              <ul id="printersList" class="small mb-0"></ul>
            </div>
          </form>
        </div>
        <div class="tab-pane fade" id="data" role="tabpanel">
          {% if stats %}
          <div class="text-muted small mb-2">Counts â€” Customers: {{ stats.customers }}, Products: {{ stats.products }}, Invoices: {{ stats.invoices }}</div>
          {% endif %}
          <div class="row g-2">
            <div class="col-lg-6">
              <form action="{{ url_for('clear_products') }}" method="post" onsubmit="return confirm('Delete ALL products? This cannot be undone.');" class="row g-2">
                <div class="col-7 col-sm-8">
                  <input type="password" class="form-control form-control-sm" name="admin_password" placeholder="Admin password" required>
                </div>
                <div class="col-5 col-sm-4 d-grid">
                  <button class="btn btn-sm btn-outline-danger"><i class="fas fa-box-open me-1"></i> Clear Products</button>
                </div>
              </form>
            </div>
            <div class="col-lg-6">
              <form action="{{ url_for('clear_customers') }}" method="post" onsubmit="return confirm('Delete ALL customers? This cannot be undone.');" class="row g-2">
                <div class="col-7 col-sm-8">
                  <input type="password" class="form-control form-control-sm" name="admin_password" placeholder="Admin password" required>
                </div>
                <div class="col-5 col-sm-4 d-grid">
                  <button class="btn btn-sm btn-outline-danger"><i class="fas fa-users me-1"></i> Clear Customers</button>
                </div>
              </form>
            </div>
            <div class="col-lg-6">
              <form action="{{ url_for('clear_invoices') }}" method="post" onsubmit="return confirm('Delete ALL invoices and PDFs? This cannot be undone.');" class="row g-2">
                <div class="col-7 col-sm-8">
                  <input type="password" class="form-control form-control-sm" name="admin_password" placeholder="Admin password" required>
                </div>
                <div class="col-5 col-sm-4 d-grid">
                  <button class="btn btn-sm btn-outline-danger"><i class="fas fa-file-invoice-dollar me-1"></i> Clear Invoices</button>
                </div>
              </form>
            </div>
            <div class="col-lg-6">
              <form action="{{ url_for('clear_all') }}" method="post" onsubmit="return confirm('Delete EVERYTHING (products, customers, invoices & PDFs)? This cannot be undone.');" class="row g-2">
                <div class="col-7 col-sm-8">
                  <input type="password" class="form-control form-control-sm" name="admin_password" placeholder="Admin password" required>
                </div>
                <div class="col-5 col-sm-4 d-grid">
                  <button class="btn btn-sm btn-danger"><i class="fas fa-exclamation-triangle me-1"></i> Clear EVERYTHING</button>
                </div>
              </form>
            </div>
          </div>
        </div>
        <div class="tab-pane fade" id="backups" role="tabpanel">
          <div class="d-flex flex-wrap gap-2">
            <a class="btn btn-sm btn-outline-secondary" href="{{ url_for('backup_db') }}"><i class="fas fa-database me-1"></i> DB Backup</a>
            <a class="btn btn-sm btn-outline-secondary" href="{{ url_for('backup_invoices') }}"><i class="fas fa-file-archive me-1"></i> Invoices ZIP</a>
            <a class="btn btn-sm btn-outline-secondary" href="{{ url_for('export_products') }}"><i class="fas fa-file-csv me-1"></i> Products CSV</a>
            <a class="btn btn-sm btn-outline-secondary" href="{{ url_for('export_customers') }}"><i class="fas fa-file-csv me-1"></i> Customers CSV</a>
          </div>
        </div>
      </div>
    </div>
  </div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
  const refreshBtn = document.getElementById('refreshPrinters');
  const list = document.getElementById('printersList');
  if (refreshBtn) {
    refreshBtn.addEventListener('click', async function(e){
      e.preventDefault();
      list.innerHTML = '<li>Loading...</li>';
      try {
        const resp = await fetch('/api/printers');
        const data = await resp.json();
        if (data.success && data.printers && data.printers.length) {
          list.innerHTML = '';
          data.printers.forEach(p => {
            const li = document.createElement('li');
            li.textContent = p;
            list.appendChild(li);
          });
        } else {
          list.innerHTML = '<li>No printers found</li>';
        }
      } catch (err) {
        list.innerHTML = '<li>Error loading printers</li>';
      }
    });
  }
});
</script>
{% endblock %}
